<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Archives: 2015 | My Free Book</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="My Free Book">
<meta property="og:url" content="http://msakamaki.github.io/myfreebook/archives/2015/">
<meta property="og:site_name" content="My Free Book">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="My Free Book">
<meta name="twitter:description">

  
    <link rel="alternative" href="/atom.xml" title="My Free Book" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/myfreebook/css/style.css" type="text/css">

  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/myfreebook/" id="logo">My Free Book</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/myfreebook/" id="subtitle">Sakamaki&#39;s Memo pad</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/myfreebook/">Home</a>
        
          <a class="main-nav-link" href="/myfreebook/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:http://msakamaki.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-angularwebrtc" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/myfreebook/2015/01/08/angularwebrtc/" class="article-date">
  <time datetime="2015-01-08T11:12:08.000Z" itemprop="datePublished">Jan 8 2015</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/myfreebook/2015/01/08/angularwebrtc/">Multi-User Video Conference with WebRTCの意訳</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>WebRTCの教材として凄く良さそうだったので、<a href="https://github.com/mgechev/angular-webrtc" target="_blank" rel="external">Angular WebRTC</a>について、<a href="http://blog.mgechev.com/2014/12/26/multi-user-video-conference-webrtc-angularjs-yeoman/" target="_blank" rel="external">Blog</a>のざっくり訳をしてみた。</p>
<hr>
<p>これは<a href="http://webrtc.org" target="_blank" rel="external">WebRTC</a>と<a href="http://angularjs.org" target="_blank" rel="external">AngularJS</a>、<a href="http://yeoman.io/" target="_blank" rel="external">Yeoman</a>で複数人で会議するためのビデオ会議アプリを作る為のチュートリアルです。</p>
<p>このチュートリアルは、WebRTCのピアツーピア接続の方法と、<a href="https://en.wikipedia.org/wiki/Interactive_Connectivity_Establishment" target="_blank" rel="external">ICE (Interactive-Connectivity Establishment) framework</a>がどのように、NATトラバーサルで使用されているのかを詳細に説明します。</p>
<p>このプロジェクトの開発版は、我々の <a href="https://mgechev-webrtc.herokuapp.com" target="_blank" rel="external">Heroku</a>で見る事が出来ます。<br>ソースコードは<a href="https://github.com/mgechev/angular-webrtc" target="_blank" rel="external">GitHub</a>に置いてあります。</p>
<h3 id="なんで私はYeomanとAngularJSを選んだのか？">なんで私はYeomanとAngularJSを選んだのか？</h3>
<p>YeomanのGeneratorは非常に早くアプリケーション開発に必要な、すべてのボイラープレートを用意する事が出来ます。<br>Yeomanは本来ならば非常に面倒なものを、bashたった数行で、効率よく最適化されたアプリケーション開発環境を用意する事ができます。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">grunt build</div><div class="line">git remote add heroku git@uri</div><div class="line">git push heroku master</div></pre></td></tr></table></figure>

<h3 id="なぜAngularJSを使ったのか？">なぜAngularJSを使ったのか？</h3>
<p>AngularJSは前提原則として、素敵なデータバインディングメカニズムによる粗結合を強制する仕組み、それによる明確に定義されたコンポーネント化の仕組み、そして(あなたがAngular-routerを使っていれば)out of the box形式のルーターがついてきます。</p>
<p>Q: AngularJSの代わりに他のものを使う事ができますか？<br>A: はい、あなたがその他の物を使う知識があれば大丈夫です。</p>
<p>難易度の高いDOM操作とビューの少ないシングルページアプリケーションの場合は、React.jsもしくはWebComponentsをお勧めします。</p>
<img src="/myfreebook/2015/01/08/angularwebrtc/webrtc-yeoman.png" class="center" width="500">

<h2 id="WebRTC_イントロダクション">WebRTC イントロダクション</h2>
<p>In my blog post <a href="http://blog.mgechev.com/2014/09/03/webrtc-peer-to-peer-chat-with-react/" target="_blank" rel="external">“WebRTC chat with React.js”</a> I already did a brief introduction about what WebRTC is and how it works:</p>
<p>私のブログの記事の[“React.jsと、チャットWebRTC」]（<a href="http://blog.mgechev.com/2014/09/03/webrtc-peer-to-peer-chat-with-react/）で、私はすでにやったWebRTCがあり、それがどのように機能するかかについての簡単な紹介：" target="_blank" rel="external">http://blog.mgechev.com/2014/09/03/webrtc-peer-to-peer-chat-with-react/）で、私はすでにやったWebRTCがあり、それがどのように機能するかかについての簡単な紹介：</a></p>
<p>私のBlog記事<a href="http://blog.mgechev.com/2014/09/03/webrtc-peer-to-peer-chat-with-react/" target="_blank" rel="external">“WebRTC chat with React.js”</a>で、既にWebRTCについて書いてあります。<br>WebRTCがどのように機能するかを簡単に紹介します。</p>
<hr>
<p>RTCはリアルタイム通信(Real-Time Communication)の略です。<br>WebRTCが登場するまで、複数のブラウザ間通信を行う為には、そのブラウザの間にサーバーを置いてメッセージをやり取りする必要がありました。<br>WebRTCが実装されているブラウザは、ブラウザ間のピアツーピア通信が行えます。<br>NATトラバーサルフレームワークを使用し、ICEを用いてブラウザ間の最も適切なルートを見つけ、それらの通信は仲介サーバーを設ける事無く行えます。<br>2014年７月１日以降、WebRTCブラウザのAPI規格は<a href="http://dev.w3.org/2011/webrtc/editor/webrtc.html" target="_blank" rel="external">W3Cによって公開</a>されています。</p>
<p>前の記事ではチャットルームに参加するピア同士でデータチャネルを開くため、Pear.jsを使いました。</p>
<p>今回は標準のブラウザに搭載されているWebRTC APIを使い、WebRTCセッションの確立されている状況をもう少し深くセスメイして行きます。</p>
<p>あなたは深い技術的理解を目指していない場合、この章をスキップして即座にサーバの実装の章へ行く事も出来ます。</p>
<h3 id="どのように作ったWebRTCが動くのか？">どのように作ったWebRTCが動くのか？</h3>
<p>以下のUMLシーケンス図を参照してください。</p>
<p><div class="mermaid">sequenceDiagram
  participant アリス
  participant Webアプリ
  participant TRUNサーバー
  participant ボブ
  %%
  アリス-&gt;&gt;Webアプリ: 1. ボブを呼び出す
  Webアプリ-&gt;&gt;ボブ: 2. アリスがあなたを呼んでいます。
  ボブ-&gt;&gt;Webアプリ: 3. アリスへ回答を返します。
  Webアプリ-&gt;&gt;アリス: 4. ボブの回答が帰ってきました。
  %%
  アリス-&gt;&gt;アリス: 5. ICE候補を取得(ICE gathering process)
  アリス-&gt;&gt;Webアプリ: 6. ボブにSDPを申請する
  Webアプリ-&gt;&gt;ボブ: 7. アリスからのSDP申請が来る
  ボブ-&gt;&gt;ボブ: 8. ICE候補を取得(ICE gathering process)
  ボブ-&gt;&gt;Webアプリ: 9. アリスから来たSDP申請に対して回答する
  Webアプリ-&gt;&gt;アリス: 10. ボブからのSDP申請の回答を受け取る
  %%
  alt 最適なICE候補が見つかった場合
    アリス-&gt;&gt;ボブ: SRDP madia session
    ボブ-&gt;&gt;アリス: SRDP madia session
  else 最適なICE候補が見つからなかった場合
    アリス-&gt;&gt;TRUNサーバー: SRDP madia session
    TRUNサーバー-&gt;&gt;ボブ:   SRDP madia session
    ボブ-&gt;&gt;TRUNサーバー:   SRDP madia session
    TRUNサーバー-&gt;&gt;アリス: SRDP madia session
  end</div></p>
<ul>
<li><a href="http://tools.ietf.org/html/rfc3264" target="_blank" rel="external">SDP(Session Description Protocol)</a></li>
<li><a href="http://ja.wikipedia.org/wiki/%E7%9B%B4%E7%A9%8D%E9%9B%86%E5%90%88" target="_blank" rel="external">直積集合</a></li>
</ul>
<p>上記のシーケンス図では、アリスが中心にあるWebアプリケーションサーバー(Webアプリ)を介して　ボブとのピア接続を確立させる方法を図解しています。</p>
<hr>
<ol>
<li><p>最初にアリスはRESTfulなメソッド(<code>POST /call/Bob</code>)を呼び出す事で、アプリケーションサーバーを通してボブを呼び出します。</p>
</li>
<li><p>プッシュ通知を介して、アプリケーションサーバーはアリスから呼ばれている事をボブに伝えます。Webアプリはアリスの呼び出しを,WebSocketを使用して通知(notification)を送る事もあります。</p>
</li>
<li><p>ボブはプッシュ通知の応答に「アリスと話をしたい」と回答します。</p>
</li>
<li><p>Webアプリはアリスに対して、ボブの回答を返します。</p>
</li>
<li><p>アリスはボブが彼女の呼び出しを受け入れたので、接続の為に必要な「ICE候補の収集プロセス(ICE candidates gathering process)」開始します。次のセクションでその内容をさらに見て行きましょう。</p>
</li>
<li><p>アリスはICE候補のセットを持っています。(例：127.0.0.1:5545, 192.168.0.112:6642, 94.23.24.56:6655、正確には<code>a=candidate:1 1 UDP 2130706431 192.168.1.102 1816 typ host</code>、ポート：ホスト - にて、ペアとしてみる事が出来る。)アリスはICE候補といくつかの追加情報(サポートされてるビデオ/オーディオコーデック情報)が含まれたSDP申請を準備します。準備が完了すると、用意していたSDP申請を送信します。</p>
</li>
<li><p>Webアプリはボブへ、アリスの申請をリダイレクトします</p>
</li>
<li><p>ボブも自分の為のICE候補を探し始めます。</p>
</li>
<li><p>ボブはSDPの返信を準備(アリスのSDPオファーと似た形)し、Webアプリを経由してアリスに回答を送信します。(ボブとアリスはまだP2P接続は確立できていません。)</p>
</li>
<li><p>Webアプリはアリスにボブの回答をリダイレクトします。</p>
</li>
<li><p>アリスとボブは互いに持っているICE候補をマッチングさせ、P2P接続を確立させようとします。この段階でも、まだICE候補の収集は行われています。</p>
<ul>
<li>アリスとボブは、互いに持っているICE候補の直積集合を作成します。<br>ボブは自分のICE候補とアリスのICE候補同士で優先順位を組み合わせながら、それらの間の接続を確立しようとします。</li>
</ul>
</li>
</ol>
<p>もしアリスとボブが互いにICE候補を用いてのP2P接続を確立できない場合、両者は<a href="http://think-like-a-computer.com/2011/09/19/symmetric-nat/" target="_blank" rel="external">symmetric NAT</a>の後ろに居る可能性が高いです。<br>TURNサーバーを提供している場合、ビデオ/オーディオ接続はそのTURNサーバーを介して通信を確立できます。<br>それ以外の場合はP2P接続は確立できません。</p>
<h4 id="ICE_gathering_process">ICE gathering process</h4>
<p>新しい<a href="http://w3c.github.io/webrtc-pc/#rtcpeerconnection-interface" target="_blank" rel="external">RTCPeerConnection</a>を作る為には、ブラウザのWebRTC APIを利用する場合、configオブジェクトを提供します。<br>ここにはSTUNとTURNサーバーのセットを含めます。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> RTCPeerConnection({ <span class="string">'iceServers'</span>: [{ <span class="string">'url'</span>: <span class="string">'stun:stun.l.google.com:19302'</span> }]})</div></pre></td></tr></table></figure>

<p>STUNの使い方を理解する為には、まず何故それが必要になるのかの理由を知る必要があります。<br>まず「NAT」が何なのかを見てみましょう。</p>
<h5 id="NAT">NAT</h5>
<p>チュートリアルを行う前に、NATに関わる幾つかの単語の概要を説明できます。</p>
<p>NATはネットワークアドレス変換(Network Address Translation.)の略です。<br>それはパブリックIPアドレスと、内部(プライベート)IPアドレスを変換する為の非常に一般的な手法です。<br>パブリックIPアドレスが限られた数しかないISPプロバイダの多くは、内部ネットワークにプライベートIPアドレスを使用して数を増やし、外部に対してはパブリックIPアドレスに変換する方法を使っています。<br>NATとNATの異なる種類似ついての詳細は<a href="https://en.wikipedia.org/wiki/Network_address_translation" target="_blank" rel="external">Wiki(英語)</a>にあります。</p>
<p>特定のホスト端末がNATの背後にあるとき、それはパブリックIPアドレスを持ちません。<br>そのIPアドレスは<a href="https://en.wikipedia.org/wiki/Private_network" target="_blank" rel="external">192.168.0.102のように</a>なり済まします。<br>特定のホスト端末がネットワークにあるサービスに到達しようとする場合、ローカルネットワークの外部にはNATサーバーを介して要求を行います。<br>NATサーバーはNATサーバーのIPアドレスを送信元アドレスにに変換する事で、要求を自身にリダイレクトさせます。<br>NATはで変換されたアドレス(ローカルにある干すと端末のホスト名とポートと、NATのホスト名)に、送信元アドレス(ホスト名とポート)をマッピングするNATテーブルを作成します。<br>NATはリモートサービスによって応答を受信すると、要求の最初のソースを見つける為にNATテーブルを使用して、対応する応答をリダイレクトします。</p>
<h5 id="STUN">STUN</h5>
<p>Q： 何故STUNサーバーが必要で、それはいったい何なんですか？<br>A：これらの質問に答える 前に、「何故私たちはNATの背後が判らないか理解できますか？」と言う話ができます。</p>
<p>NATの後ろに居る私たちがリモートサービスに到達したいと仮定します。</p>
<p>まず、リモートサービスに要求を行った場合、リクエストの送信もとアドレスを持つサービスのレスポンスと、自分自身のマシンのアドレスを比較します。<br>その時にもしアドレスが異なる場合は、私たちがNATの背後に居る事が明らかです。<br>サービスが私たちのローカルネットワーク(s)の外に位置する必要がある事に注意してください。</p>
<p>Q: 私たちはどのようにすれば確実に、サービスの応答内容から受信したアドレスと、上記のNATのひとつであるかを確認できますか？<br>A: 私たちにはできません、ネストされたNATの例では、いくつかのNATを経由した先かもしれないが、基本的にはICEのNATトラバーサル手順は同じです。</p>
<p>では、リクエストの送信元アドレスを持つサービスのレスポンスで、STUNが何をするかです。</p>
<p>私たちのNATのIPアドレスを持っているときは、私たちはリフレクションICE候補(reflexive ICE candidate)と呼ばれる新しいICE候補を使う事が出来ます。<br>これは、そのネットワークアドレス変換で使用されるNATサーバーの、IPアドレスとポートの組み合わせです。</p>
<h2 id="実装">実装</h2>
<p>次のステップでは、私たちのサンプルアプリケーションの実装を見て行きます。<br>アプリケーションは２つの主要コンポーネントでできています。</p>
<ul>
<li>バックエンド - アプリケーションサーバー(シーケンス図のWebアプリ)、P2P接続が確立されるまでの間の端末間の通信を担当します。</li>
<li>Webアプリ - AngularJSアプリケーションです(シーケンス図のアリスとボブ)、実際のマルチユーザービデオチャットです。</li>
</ul>
<p>あなたは<a href="https://mgechev-webrtc.herokuapp.com" target="_blank" rel="external">Heroku</a>を使う事でこのアプリケーションを実際に試せます。</p>
<h2 id="バックエンド">バックエンド</h2>
<p>このセクションではバックエンドを実装します。<br>バックエンドは前にあるシーケンス図のWebアプリです。<br>主な基本機能は静的ファイル(HTML,JS,CSS)を提供することと、ピアによる要求のリダイレクトです。</p>
<p>このコンポーネントは、与えられた部屋同士で<code>socket.io</code>のピアなソケットコネクションが関連付けられており、各部屋のコネクションを維持します。</p>
<p>JavaScriptで私たちのWebRTCアプリケーションを実現する為に、バックエンドにはNode.jsを使用しています。</p>
<h3 id="それでは始めましょう！">それでは始めましょう！</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mkdir webrtc-app && <span class="built_in">cd</span> webrtc-app</div><div class="line"><span class="comment"># initialize the app</span></div><div class="line">npm init</div><div class="line">mkdir lib</div><div class="line">touch index.js</div></pre></td></tr></table></figure>

<p>ルートフォルダにindex.jsを作成し、以下の内容を追記します。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> config = <span class="built_in">require</span>(<span class="string">'./config/config.json'</span>),</div><div class="line">    server = <span class="built_in">require</span>(<span class="string">'./lib/server'</span>);</div><div class="line"></div><div class="line"><span class="comment">// ポートは(Herokuの)環境変数を使用して設定されている。</span></div><div class="line">config.PORT = process.env.PORT || config.PORT;</div><div class="line"></div><div class="line">server.run(config);</div></pre></td></tr></table></figure>

<p>アプリケーションの中心となる依存関係をインストールする為に、以下のコマンドを実行します。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">npm install express --save</div><div class="line">npm install socket.io --save</div><div class="line">npm install node-uuid --save</div></pre></td></tr></table></figure>

<p>では、上で作った<code>lib</code>ディレクトリに移動しましょう。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> lib</div></pre></td></tr></table></figure>

<p>次に、このディレクトリ<code>lib</code>で、<code>server.js</code>と言うファイルを作ります。<br>内容は以下ののようになります。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>),</div><div class="line">    expressApp = express(),</div><div class="line">    socketio = <span class="built_in">require</span>(<span class="string">'socket.io'</span>),</div><div class="line">    http = <span class="built_in">require</span>(<span class="string">'http'</span>),</div><div class="line">    server = http.createServer(expressApp),</div><div class="line">    uuid = <span class="built_in">require</span>(<span class="string">'node-uuid'</span>),</div><div class="line">    rooms = {},</div><div class="line">    userIds = {};</div><div class="line"></div><div class="line">expressApp.use(express.static(__dirname + <span class="string">'/../public/dist/'</span>));</div><div class="line"></div><div class="line">exports.run = <span class="function"><span class="keyword">function</span> <span class="params">(config)</span> </span>{</div><div class="line"></div><div class="line">  server.listen(config.PORT);</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Listening on'</span>, config.PORT);</div><div class="line">  socketio.listen(server, { log: <span class="literal">false</span> })</div><div class="line">  .on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(socket)</span> </span>{</div><div class="line"></div><div class="line">    <span class="keyword">var</span> currentRoom, id;</div><div class="line"></div><div class="line">    socket.on(<span class="string">'init'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(data, fn)</span> </span>{</div><div class="line">      currentRoom = (data || {}).room || uuid.v4();</div><div class="line">      <span class="keyword">var</span> room = rooms[currentRoom];</div><div class="line">      <span class="keyword">if</span> (!data) {</div><div class="line">        rooms[currentRoom] = [socket];</div><div class="line">        id = userIds[currentRoom] = <span class="number">0</span>;</div><div class="line">        fn(currentRoom, id);</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Room created, with #'</span>, currentRoom);</div><div class="line">      } <span class="keyword">else</span> {</div><div class="line">        <span class="keyword">if</span> (!room) {</div><div class="line">          <span class="keyword">return</span>;</div><div class="line">        }</div><div class="line">        userIds[currentRoom] += <span class="number">1</span>;</div><div class="line">        id = userIds[currentRoom];</div><div class="line">        fn(currentRoom, id);</div><div class="line">        room.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(s)</span> </span>{</div><div class="line">          s.emit(<span class="string">'peer.connected'</span>, { id: id });</div><div class="line">        });</div><div class="line">        room[id] = socket;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Peer connected to room'</span>, currentRoom, <span class="string">'with #'</span>, id);</div><div class="line">      }</div><div class="line">    });</div><div class="line"></div><div class="line">    socket.on(<span class="string">'msg'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> </span>{</div><div class="line">      <span class="keyword">var</span> to = <span class="built_in">parseInt</span>(data.to, <span class="number">10</span>);</div><div class="line">      <span class="keyword">if</span> (rooms[currentRoom] && rooms[currentRoom][to]) {</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Redirecting message to'</span>, to, <span class="string">'by'</span>, data.by);</div><div class="line">        rooms[currentRoom][to].emit(<span class="string">'msg'</span>, data);</div><div class="line">      } <span class="keyword">else</span> {</div><div class="line">        <span class="built_in">console</span>.warn(<span class="string">'Invalid user'</span>);</div><div class="line">      }</div><div class="line">    });</div><div class="line"></div><div class="line">    socket.on(<span class="string">'disconnect'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">      <span class="keyword">if</span> (!currentRoom || !rooms[currentRoom]) {</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      }</div><div class="line">      <span class="keyword">delete</span> rooms[currentRoom][rooms[currentRoom].indexOf(socket)];</div><div class="line">      rooms[currentRoom].forEach(<span class="function"><span class="keyword">function</span> <span class="params">(socket)</span> </span>{</div><div class="line">        <span class="keyword">if</span> (socket) {</div><div class="line">          socket.emit(<span class="string">'peer.disconnected'</span>, { id: id });</div><div class="line">        }</div><div class="line">      });</div><div class="line">    });</div><div class="line">  });</div><div class="line">};</div></pre></td></tr></table></figure>

<p>それでは上記のコードステップ毎に見て行きましょう。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>),</div><div class="line">    expressApp = express(),</div><div class="line">    socketio = <span class="built_in">require</span>(<span class="string">'socket.io'</span>),</div><div class="line">    http = <span class="built_in">require</span>(<span class="string">'http'</span>),</div><div class="line">    server = http.createServer(expressApp),</div><div class="line">    uuid = <span class="built_in">require</span>(<span class="string">'node-uuid'</span>),</div><div class="line">    rooms = {},</div><div class="line">    userIds = {};</div><div class="line"></div><div class="line">expressApp.use(express.static(__dirname + <span class="string">'/../public/dist/'</span>));</div></pre></td></tr></table></figure>

<p>この部分では、すべての依存関係をrequireし、作成されたexpressが静的ファイルを提供するためのディレクトリを構成/設定します。<br>このディレクトリは我々のアプリのルート直下にある<code>public</code>フォルダの中に位置します。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">server.listen(config.PORT);</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'Listening on'</span>, config.PORT);</div><div class="line">socketio.listen(server, { log: <span class="literal">false</span> })</div><div class="line">.on(<span class="string">'connection'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(socket)</span> </span>{</div><div class="line">  <span class="comment">// 追加のロジック</span></div><div class="line">});</div></pre></td></tr></table></figure>

<p>socket.ioの’connection’イベント（追加のロジック部分）は、クライアントがこのサーバーに接続した事を意味します。<br>この接続が確立したら、対応するイベントハンドラを追加する必要があります。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> currentRoom, id;</div><div class="line"></div><div class="line">socket.on(<span class="string">'init'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(data, fn)</span> </span>{</div><div class="line">  <span class="comment">// Handle init message</span></div><div class="line">});</div><div class="line"></div><div class="line">socket.on(<span class="string">'msg'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> </span>{</div><div class="line">  <span class="comment">// Handle message</span></div><div class="line">});</div><div class="line"></div><div class="line">socket.on(<span class="string">'disconnect'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">  <span class="comment">// Handle disconnect event</span></div><div class="line">});</div></pre></td></tr></table></figure>

<p>これから扱う予定の３つのイベントです。</p>
<p>initイベントは、ビデオチャットルームの初期化に使用します。<br>ビデオチャットルームが既に作成されている場合、与えられた部屋に関係したソケットのコレクションに、クライアントからのソケットを追加する事でビデオチャットルームに現在のクライアントを参加させます。(<code>rooms[room_id]</code>に、ビデオチャットルームのクライアント配列が入っています)<br>部屋が作成されていない場合、部屋を作成して現在のクライアントを追加します。<br>部屋の作成には<a href="https://github.com/broofa/node-uuid#getting-started" target="_blank" rel="external"><code>node-uuid</code> module</a>で乱数を用いて一意の部屋を作り出します。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">currentRoom = (data || {}).room || uuid.v4();</div><div class="line"><span class="keyword">var</span> room = rooms[currentRoom];</div><div class="line"><span class="keyword">if</span> (!data) {</div><div class="line">  rooms[currentRoom] = [socket];</div><div class="line">  id = userIds[currentRoom] = <span class="number">0</span>;</div><div class="line">  fn(currentRoom, id);</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Room created, with #'</span>, currentRoom);</div><div class="line">} <span class="keyword">else</span> {</div><div class="line">  <span class="keyword">if</span> (!room) {</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">  }</div><div class="line">  userIds[currentRoom] += <span class="number">1</span>;</div><div class="line">  id = userIds[currentRoom];</div><div class="line">  fn(currentRoom, id);</div><div class="line">  room.forEach(<span class="function"><span class="keyword">function</span> <span class="params">(s)</span> </span>{</div><div class="line">    s.emit(<span class="string">'peer.connected'</span>, { id: id });</div><div class="line">  });</div><div class="line">  room[id] = socket;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Peer connected to room'</span>, currentRoom, <span class="string">'with #'</span>, id);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>もう一つの機能としては、クライアントが与えられた部屋に接続したときに、新しく接続されたピア接続を、同じビデオチャットルームにいる他のピア接続すべてに通知する事が必要です。</p>
<p>クライアントが正常に接続された後、クライアントのIDとビデオチャットルームのIDとで呼び出すコールバック関数(<code>fn</code>)を持ちます。</p>
<p>‘msg’イベントは、別のピアから特定のピアへ、<code>SDP</code>メッセージ、もしくは<code>ICE</code>候補をリダイレクトさせます。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> to = <span class="built_in">parseInt</span>(data.to, <span class="number">10</span>);</div><div class="line"><span class="keyword">if</span> (rooms[currentRoom] && rooms[currentRoom][to]) {</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Redirecting message to'</span>, to, <span class="string">'by'</span>, data.by);</div><div class="line">  rooms[currentRoom][to].emit(<span class="string">'msg'</span>, data);</div><div class="line">} <span class="keyword">else</span> {</div><div class="line">  <span class="built_in">console</span>.warn(<span class="string">'Invalid user'</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>与えられたピアのIDには常に整数が格納されているので、<br>イベントハンドラの最初の行で数値として変換します。</p>
<p>その後、イベントデータオブジェクトの<code>to</code>プロパティで指定したピアにメッセージを送ります。</p>
<p>最後のイベントハンドラ(および、サーバの最後の部分)が切断を行う為のイベントハンドラです。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (!currentRoom || !rooms[currentRoom]) {</div><div class="line">  <span class="keyword">return</span>;</div><div class="line">}</div><div class="line"><span class="keyword">delete</span> rooms[currentRoom][rooms[currentRoom].indexOf(socket)];</div><div class="line">rooms[currentRoom].forEach(<span class="function"><span class="keyword">function</span> <span class="params">(socket)</span> </span>{</div><div class="line">  <span class="keyword">if</span> (socket) {</div><div class="line">    socket.emit(<span class="string">'peer.disconnected'</span>, { id: id });</div><div class="line">  }</div><div class="line">});</div></pre></td></tr></table></figure>

<p>サーバーから与えられたピアが切断された場合(例：ユーザーがブラウザを閉じるかF5等で更新をする。)、与えられた部屋のソケットリストから、該当するクライアントのソケットを削除します。(delete演算子を使う)<br>その後に、切断されたピアのidで、部屋の中の他のすべてのピアに対して<code>peer.disconnected</code>イベントを送ります。<br>このように、切断されたピアの情報が、すべての接続されたクライアントに対して送られ、クライアントのビデオ要素を削除する事が出来るようになります。</p>
<p>バックエンドの最後に設定を作ります。<br>ルートディレクトリの直下にconfigと言うディレクトリを作ります。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> .. <span class="comment"># 今あなたがlibディレクトリに居る場合...</span></div><div class="line">mkdir config && <span class="built_in">cd</span> config</div></pre></td></tr></table></figure>

<p>新しいファイル<code>config.json</code>を作って、以下の内容を書きます。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">{</div><div class="line">  "<span class="attribute">PORT</span>": <span class="value"><span class="number">5555</span></span></div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="Webクライアント">Webクライアント</h2>
<h3 id="セットアップ">セットアップ</h3>
<p>yeoman generatorを使ってAngularJSのアプリケーションを作るには、次の手順に従います。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">npm install -g yeoman</div><div class="line">npm install -g generator-angular</div><div class="line"><span class="comment"># もしあなたがconfigディレクトリに居る場合...</span></div><div class="line"><span class="built_in">cd</span> ..</div><div class="line">mkdir public && <span class="built_in">cd</span> public</div><div class="line">yo angular</div></pre></td></tr></table></figure>

<p>あなたはyeomanから幾つかの質問をされますが、次のように答えましょう。</p>
<img src="/myfreebook/2015/01/08/angularwebrtc/setup.png" class="center" width="500">

<p>基本、依存するモジュールとして<code>angular-route</code> を必要とします。<br>簡単により良い見た目にする為にBootstrapを使って少しの労力で作ろうと思います。</p>
<h3 id="実装-1">実装</h3>
<p>まず最初に、いくつかのブラウザ互換をなんとかする必要があります。<br><code>public/app/scripts</code>ディレクトリの中に<code>adapter.js</code>を作り、次にその中身を書きます。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">window</span>.RTCPeerConnection = <span class="built_in">window</span>.RTCPeerConnection || <span class="built_in">window</span>.webkitRTCPeerConnection || <span class="built_in">window</span>.mozRTCPeerConnection;</div><div class="line"><span class="built_in">window</span>.RTCIceCandidate = <span class="built_in">window</span>.RTCIceCandidate || <span class="built_in">window</span>.mozRTCIceCandidate || <span class="built_in">window</span>.webkitRTCIceCandidate;</div><div class="line"><span class="built_in">window</span>.RTCSessionDescription = <span class="built_in">window</span>.RTCSessionDescription || <span class="built_in">window</span>.mozRTCSessionDescription || <span class="built_in">window</span>.webkitRTCSessionDescription;</div><div class="line"><span class="built_in">window</span>.URL = <span class="built_in">window</span>.URL || <span class="built_in">window</span>.mozURL || <span class="built_in">window</span>.webkitURL;</div><div class="line"><span class="built_in">window</span>.navigator.getUserMedia = <span class="built_in">window</span>.navigator.getUserMedia || <span class="built_in">window</span>.navigator.webkitGetUserMedia || <span class="built_in">window</span>.navigator.mozGetUserMedia;</div></pre></td></tr></table></figure>

<p>FirefoxとChromeはまだmozとwebkitのベンダープレフィックスが必要なので、その部分をなんとかしましょう。</p>
<p>よし！これでこの未来的を感じるアプリはChromeとFirefoxの上で動作します！</p>
<p>これで、アプリケーション内のコンポーネントに、メディアストリームを提供する<code>VideoStream</code>と言うServiceを作る準備が整いました。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yo angular:factory VideoStream</div></pre></td></tr></table></figure>

<p>で、上のサブジェネレータにより作られたファイルを編集しましょう。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'publicApp'</span>)</div><div class="line">  .factory(<span class="string">'VideoStream'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($q)</span> </span>{</div><div class="line">    <span class="keyword">var</span> stream;</div><div class="line">    <span class="keyword">return</span> {</div><div class="line">      get: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">        <span class="keyword">if</span> (stream) {</div><div class="line">          <span class="keyword">return</span> $q.when(stream);</div><div class="line">        } <span class="keyword">else</span> {</div><div class="line">          <span class="keyword">var</span> d = $q.defer();</div><div class="line">          navigator.getUserMedia({</div><div class="line">            video: <span class="literal">true</span>,</div><div class="line">            audio: <span class="literal">true</span></div><div class="line">          }, <span class="function"><span class="keyword">function</span> <span class="params">(s)</span> </span>{</div><div class="line">            stream = s;</div><div class="line">            d.resolve(stream);</div><div class="line">          }, <span class="function"><span class="keyword">function</span> <span class="params">(e)</span> </span>{</div><div class="line">            d.reject(e);</div><div class="line">          });</div><div class="line">          <span class="keyword">return</span> d.promise;</div><div class="line">        }</div><div class="line">      }</div><div class="line">    };</div><div class="line">  });</div></pre></td></tr></table></figure>

<p><code>VideoStream</code>は<code>getUserMedia</code>を使ってビデオストリームを提供するために<code>$q</code>を使用しています。<br>最初呼び出したら<code>getUserMedia</code>は、マイクとカメラを使用する権限をユーザーに訪ねます。</p>
<img src="/myfreebook/2015/01/08/angularwebrtc/webcam-permissions.png" class="center" width="500">

<p>ウェブカメラへのアクセス権確認が度々起こらないようにするため、ビデオストリームのアクセス権を取得した後、<code>stream</code>変数へキャッシュします。</p>
<h4 id="アプリケーションの構成">アプリケーションの構成</h4>
<p>では、これからアプリケーションのルーターを設定して行きます。<br><code>public/app/scripts/app.js</code>を編集できるようにし、いかにあるようなルート定義を追加します。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">angular</div><div class="line">  .module(<span class="string">'publicApp'</span>, [</div><div class="line">    <span class="string">'ngRoute'</span></div><div class="line">  ])</div><div class="line">  .config(<span class="function"><span class="keyword">function</span> <span class="params">($routeProvider)</span> </span>{</div><div class="line">    $routeProvider</div><div class="line">      .when(<span class="string">'/room/:roomId'</span>, {</div><div class="line">        templateUrl: <span class="string">'views/room.html'</span>,</div><div class="line">        controller: <span class="string">'RoomCtrl'</span></div><div class="line">      })</div><div class="line">      .when(<span class="string">'/room'</span>, {</div><div class="line">        templateUrl: <span class="string">'views/room.html'</span>,</div><div class="line">        controller: <span class="string">'RoomCtrl'</span></div><div class="line">      })</div><div class="line">      .otherwise({</div><div class="line">        redirectTo: <span class="string">'/room'</span></div><div class="line">      });</div><div class="line">  });</div></pre></td></tr></table></figure>

<p>この設定には２つのルーター設定があります。</p>
<ul>
<li><p><code>/room</code></p>
<ul>
<li>初めてアプリケーションにアクセスしたユーザーの為のページです。</li>
</ul>
<ol>
<li>まず、<code>/room</code>に訪れると、自分のWebカメラ(<code>RoomCtrl</code>のロジック)へのアクセスを可能にした後、自動的に新しい部屋が割り当てられ、別のURL(<code>/room/:roomid</code>)にリダイレクトされます。</li>
<li>このURLにリダイレクトされると、自分が話したい他のユーザーにこの部屋のURLを共有する事が出来ます。</li>
</ol>
</li>
<li><p><code>/room/:roomid</code> </p>
<ul>
<li>このURLを共有する事で、既に部屋を作成しているユーザーのビデオ通話に参加することができます。</li>
</ul>
</li>
</ul>
<p>わかりやすくするために、このメカニズムは単純かつ、安全ではありません、別のユーザーのセッションURLを推測することで、たいした努力もせずに別のユーザーのビデオ会話に参加できてしまいます。<br>他のユーザーのプライバシーを損なわないよう、礼儀正しくありましょう　:-)</p>
<p>では、<code>app.js</code>の下の方にconstantを追加しましょう。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'publicApp'</span>)</div><div class="line">  .constant(<span class="string">'config'</span>, {</div><div class="line">      <span class="comment">// Change it for your app URL</span></div><div class="line">      SIGNALIG_SERVER_URL: YOUR_APP_URL</div><div class="line">  });</div></pre></td></tr></table></figure>

<p>サーバとクライアントの<code>socket.io</code>接続の為にこの定数を使っています。</p>
<h4 id="Io">Io</h4>
<p>それではこれから、Service<code>Io</code>を作成しましょう。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yo angular:factory Io</div></pre></td></tr></table></figure>

<p>ファイル<code>/public/app/scripts/services/io.js</code>の内容に以下を書きます。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'publicApp'</span>)</div><div class="line">  .factory(<span class="string">'Io'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> io === <span class="string">'undefined'</span>) {</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Socket.io required'</span>);</div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> io;</div><div class="line">  });</div></pre></td></tr></table></figure>

<p>ここでは、ラッパーサービス内部でグローバルに存在する<code>io</code>をInjectできるようにしています。<br>この目的は、<code>io</code>テストをするときにmonkeyで簡単にモックすることができるからです。</p>
<h4 id="RoomCtrl">RoomCtrl</h4>
<p>Now lets create a new controller, called <code>RoomCtrl</code>:</p>
<p>では今から<code>RoomCtrl</code>と言う新しいコントローラを作りましょう。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yo angular:controller Room</div></pre></td></tr></table></figure>

<p>ファイル<code>/public/app/scripts/controllers/room.js</code>を編集します。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'publicApp'</span>)</div><div class="line">  .controller(<span class="string">'RoomCtrl'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($sce, VideoStream, $location, $routeParams, $scope, Room)</span> </span>{</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!<span class="built_in">window</span>.RTCPeerConnection || !navigator.getUserMedia) {</div><div class="line">      $scope.error = <span class="string">'WebRTC is not supported by your browser. You can try the app with Chrome and Firefox.'</span>;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">var</span> stream;</div><div class="line"></div><div class="line">    VideoStream.get()</div><div class="line">    .then(<span class="function"><span class="keyword">function</span> <span class="params">(s)</span> </span>{</div><div class="line">      stream = s;</div><div class="line">      Room.init(stream);</div><div class="line">      stream = URL.createObjectURL(stream);</div><div class="line">      <span class="keyword">if</span> (!$routeParams.roomId) {</div><div class="line">        Room.createRoom()</div><div class="line">        .then(<span class="function"><span class="keyword">function</span> <span class="params">(roomId)</span> </span>{</div><div class="line">          $location.path(<span class="string">'/room/'</span> + roomId);</div><div class="line">        });</div><div class="line">      } <span class="keyword">else</span> {</div><div class="line">        Room.joinRoom($routeParams.roomId);</div><div class="line">      }</div><div class="line">    }, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">      $scope.error = <span class="string">'No audio/video permissions. Please refresh your browser and allow the audio/video capturing.'</span>;</div><div class="line">    });</div><div class="line">    $scope.peers = [];</div><div class="line">    Room.on(<span class="string">'peer.stream'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(peer)</span> </span>{</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'Client connected, adding new stream'</span>);</div><div class="line">      $scope.peers.push({</div><div class="line">        id: peer.id,</div><div class="line">        stream: URL.createObjectURL(peer.stream)</div><div class="line">      });</div><div class="line">    });</div><div class="line">    Room.on(<span class="string">'peer.disconnected'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(peer)</span> </span>{</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">'Client disconnected, removing stream'</span>);</div><div class="line">      $scope.peers = $scope.peers.filter(<span class="function"><span class="keyword">function</span> <span class="params">(p)</span> </span>{</div><div class="line">        <span class="keyword">return</span> p.id !== peer.id;</div><div class="line">      });</div><div class="line">    });</div><div class="line"></div><div class="line">    $scope.getLocalVideo = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">      <span class="keyword">return</span> $sce.trustAsResourceUrl(stream);</div><div class="line">    };</div><div class="line">  });</div></pre></td></tr></table></figure>

<p>このコードをステップ毎に見て行きましょう。</p>
<p><code>RoomCtrl</code>には次のような目的で依存関係を追加しています。</p>
<ul>
<li><code>$sce</code> -video要素のソースを設定するのに使う</li>
<li><code>VideoStream</code> - ユーザーのカメラからビデオストリームを取得しキャッシュする。</li>
<li><code>$location</code> - チャットルームのURLに、ユーザーをリダイレクトするのに使います。</li>
<li><code>$routeParams</code> - ルームIDを取得するのに使います。</li>
<li><code>$scope</code> - ビューとデータのバインドを行う為に必要です。</li>
<li><code>Room</code> - これから作ろうとしているService部分、ここでP2P接続を管理します。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (!<span class="built_in">window</span>.RTCPeerConnection || !navigator.getUserMedia) {</div><div class="line">  $scope.error = <span class="string">'WebRTC is not supported by your browser. You can try the app with Chrome and Firefox.'</span>;</div><div class="line">  <span class="keyword">return</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>上記のコードは、WebRTCがサポートされているかを確認しています。<br>これは単純に<code>$scope.error</code>へ使えない旨のメッセージを設定して、コントローラの処理をさせないようにしています。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> stream;</div><div class="line">VideoStream.get()</div><div class="line">.then(<span class="function"><span class="keyword">function</span> <span class="params">(s)</span> </span>{</div><div class="line">  stream = s;</div><div class="line">  Room.init(stream);</div><div class="line">  stream = URL.createObjectURL(stream);</div><div class="line">  <span class="keyword">if</span> (!$routeParams.roomId) {</div><div class="line">    Room.createRoom()</div><div class="line">    .then(<span class="function"><span class="keyword">function</span> <span class="params">(roomId)</span> </span>{</div><div class="line">      $location.path(<span class="string">'/room/'</span> + roomId);</div><div class="line">    });</div><div class="line">  } <span class="keyword">else</span> {</div><div class="line">    Room.joinRoom($routeParams.roomId);</div><div class="line">  }</div><div class="line">}, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">  $scope.error = <span class="string">'No audio/video permissions. Please refresh your browser and allow the audio/video capturing.'</span>;</div><div class="line">});</div></pre></td></tr></table></figure>

<p><code>VideoStream.get()</code>は最初にユーザーのメディアストリーム情報をresolvedするpromiseを返却します。<br>promiseがresolvedされると<code>Room</code>にStremを渡して初期化させます。<br>ユーザーのWebカメラで撮影した映像を見えるようにするため、<code>URL.createObjectURL</code>は、HTMLのvideo要素のsrcにその内容を設定する事が出来るようになる筈です。</p>
<p>次のステップとして、<code>roomid</code>が提供されているかどうかを確認してください。<br>提供されている場合は、roomid付きの部屋に参加しに行きます</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">roomId`:`Room.joinRoom($routeParams.roomId);</div></pre></td></tr></table></figure>

<p>そうでない場合、新しい部屋を作成します。<br>部屋が作られた後、クライアントはその部屋にリダイレクトされます。</p>
<p><code>RoomCtrl</code>の残り２つのイベント処理についてです</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Room.on(<span class="string">'peer.stream'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(peer)</span> </span>{</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Client connected, adding new stream'</span>);</div><div class="line">  $scope.peers.push({</div><div class="line">    id: peer.id,</div><div class="line">    stream: URL.createObjectURL(peer.stream)</div><div class="line">  });</div><div class="line">});</div><div class="line">Room.on(<span class="string">'peer.disconnected'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(peer)</span> </span>{</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'Client disconnected, removing stream'</span>);</div><div class="line">  $scope.peers = $scope.peers.filter(<span class="function"><span class="keyword">function</span> <span class="params">(p)</span> </span>{</div><div class="line">    <span class="keyword">return</span> p.id !== peer.id;</div><div class="line">  });</div><div class="line">});</div></pre></td></tr></table></figure>

<ul>
<li><code>peer.stream</code> - ピアStreamが受信されます。新しいピアStreamを受信し、ページ上で見えるようになっている<code>$scope.peers</code>配列に追加します。ページのマークアップはvideo要素にそれぞれの<code>stream</code>をマップします。</li>
<li><code>peer.disconnected</code> - ピアが切断されると <code>peer.disconnected</code>イベントが発生します。このイベントを受け取ったとき、接続のコレクションから該当のピアを削除することができます。</li>
</ul>
<h4 id="Room_service">Room service</h4>
<p>最後のコンポーネント<code>Room</code> serviceを作って行きましょう。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yo angular:factory Room</div></pre></td></tr></table></figure>

<p>ファイル <code>/public/app/scripts/services/room.js</code> を編集して次の内容を設定して行きます。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'publicApp'</span>)</div><div class="line">  .factory(<span class="string">'Room'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($rootScope, $q, Io, config)</span> </span>{</div><div class="line"></div><div class="line">    <span class="keyword">var</span> iceConfig = { <span class="string">'iceServers'</span>: [{ <span class="string">'url'</span>: <span class="string">'stun:stun.l.google.com:19302'</span> }]},</div><div class="line">        peerConnections = {},</div><div class="line">        currentId, roomId,</div><div class="line">        stream;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getPeerConnection</span><span class="params">(id)</span> </span>{</div><div class="line">      <span class="keyword">if</span> (peerConnections[id]) {</div><div class="line">        <span class="keyword">return</span> peerConnections[id];</div><div class="line">      }</div><div class="line">      <span class="keyword">var</span> pc = <span class="keyword">new</span> RTCPeerConnection(iceConfig);</div><div class="line">      peerConnections[id] = pc;</div><div class="line">      pc.addStream(stream);</div><div class="line">      pc.onicecandidate = <span class="function"><span class="keyword">function</span> <span class="params">(evnt)</span> </span>{</div><div class="line">        socket.emit(<span class="string">'msg'</span>, { by: currentId, to: id, ice: evnt.candidate, type: <span class="string">'ice'</span> });</div><div class="line">      };</div><div class="line">      pc.onaddstream = <span class="function"><span class="keyword">function</span> <span class="params">(evnt)</span> </span>{</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Received new stream'</span>);</div><div class="line">        api.trigger(<span class="string">'peer.stream'</span>, [{</div><div class="line">          id: id,</div><div class="line">          stream: evnt.stream</div><div class="line">        }]);</div><div class="line">        <span class="keyword">if</span> (!$rootScope.$$digest) {</div><div class="line">          $rootScope.$apply();</div><div class="line">        }</div><div class="line">      };</div><div class="line">      <span class="keyword">return</span> pc;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">makeOffer</span><span class="params">(id)</span> </span>{</div><div class="line">      <span class="keyword">var</span> pc = getPeerConnection(id);</div><div class="line">      pc.createOffer(<span class="function"><span class="keyword">function</span> <span class="params">(sdp)</span> </span>{</div><div class="line">        pc.setLocalDescription(sdp);</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Creating an offer for'</span>, id);</div><div class="line">        socket.emit(<span class="string">'msg'</span>, { by: currentId, to: id, sdp: sdp, type: <span class="string">'sdp-offer'</span> });</div><div class="line">      }, <span class="function"><span class="keyword">function</span> <span class="params">(e)</span> </span>{</div><div class="line">        <span class="built_in">console</span>.log(e);</div><div class="line">      },</div><div class="line">      { mandatory: { OfferToReceiveVideo: <span class="literal">true</span>, OfferToReceiveAudio: <span class="literal">true</span> }});</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">handleMessage</span><span class="params">(data)</span> </span>{</div><div class="line">      <span class="keyword">var</span> pc = getPeerConnection(data.by);</div><div class="line">      <span class="keyword">switch</span> (data.type) {</div><div class="line">        <span class="keyword">case</span> <span class="string">'sdp-offer'</span>:</div><div class="line">          pc.setRemoteDescription(<span class="keyword">new</span> RTCSessionDescription(data.sdp), <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'Setting remote description by offer'</span>);</div><div class="line">            pc.createAnswer(<span class="function"><span class="keyword">function</span> <span class="params">(sdp)</span> </span>{</div><div class="line">              pc.setLocalDescription(sdp);</div><div class="line">              socket.emit(<span class="string">'msg'</span>, { by: currentId, to: data.by, sdp: sdp, type: <span class="string">'sdp-answer'</span> });</div><div class="line">            });</div><div class="line">          });</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'sdp-answer'</span>:</div><div class="line">          pc.setRemoteDescription(<span class="keyword">new</span> RTCSessionDescription(data.sdp), <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'Setting remote description by answer'</span>);</div><div class="line">          }, <span class="function"><span class="keyword">function</span> <span class="params">(e)</span> </span>{</div><div class="line">            <span class="built_in">console</span>.error(e);</div><div class="line">          });</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="string">'ice'</span>:</div><div class="line">          <span class="keyword">if</span> (data.ice) {</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'Adding ice candidates'</span>);</div><div class="line">            pc.addIceCandidate(<span class="keyword">new</span> RTCIceCandidate(data.ice));</div><div class="line">          }</div><div class="line">          <span class="keyword">break</span>;</div><div class="line">      }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">var</span> socket = Io.connect(config.SIGNALIG_SERVER_URL),</div><div class="line">        connected = <span class="literal">false</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">addHandlers</span><span class="params">(socket)</span> </span>{</div><div class="line">      socket.on(<span class="string">'peer.connected'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(params)</span> </span>{</div><div class="line">        makeOffer(params.id);</div><div class="line">      });</div><div class="line">      socket.on(<span class="string">'peer.disconnected'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> </span>{</div><div class="line">        api.trigger(<span class="string">'peer.disconnected'</span>, [data]);</div><div class="line">        <span class="keyword">if</span> (!$rootScope.$$digest) {</div><div class="line">          $rootScope.$apply();</div><div class="line">        }</div><div class="line">      });</div><div class="line">      socket.on(<span class="string">'msg'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> </span>{</div><div class="line">        handleMessage(data);</div><div class="line">      });</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">var</span> api = {</div><div class="line">      joinRoom: <span class="function"><span class="keyword">function</span> <span class="params">(r)</span> </span>{</div><div class="line">        <span class="keyword">if</span> (!connected) {</div><div class="line">          socket.emit(<span class="string">'init'</span>, { room: r }, <span class="function"><span class="keyword">function</span> <span class="params">(roomid, id)</span> </span>{</div><div class="line">            currentId = id;</div><div class="line">            roomId = roomid;</div><div class="line">          });</div><div class="line">          connected = <span class="literal">true</span>;</div><div class="line">        }</div><div class="line">      },</div><div class="line">      createRoom: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">        <span class="keyword">var</span> d = $q.defer();</div><div class="line">        socket.emit(<span class="string">'init'</span>, <span class="literal">null</span>, <span class="function"><span class="keyword">function</span> <span class="params">(roomid, id)</span> </span>{</div><div class="line">          d.resolve(roomid);</div><div class="line">          roomId = roomid;</div><div class="line">          currentId = id;</div><div class="line">          connected = <span class="literal">true</span>;</div><div class="line">        });</div><div class="line">        <span class="keyword">return</span> d.promise;</div><div class="line">      },</div><div class="line">      init: <span class="function"><span class="keyword">function</span> <span class="params">(s)</span> </span>{</div><div class="line">        stream = s;</div><div class="line">      }</div><div class="line">    };</div><div class="line">    EventEmitter.call(api);</div><div class="line">    <span class="built_in">Object</span>.setPrototypeOf(api, EventEmitter.prototype);</div><div class="line"></div><div class="line">    addHandlers(socket);</div><div class="line">    <span class="keyword">return</span> api;</div><div class="line">  });</div></pre></td></tr></table></figure>

<p><code>Room</code>は以下の依存関係を持ちます。</p>
<ul>
<li><code>$rootScope</code> - <code>socket.io</code>イベントが受信される<code>$digest</code>のループイベントを呼び出す為に使われています。<code>socket.io</code>イベントハンドラが<code>$scope.$apply</code>内にラップされていないため、我々はマニュアルで<code>$digest</code>を起動する必要があります。</li>
<li><code>$q</code> - promiseベースのインタフェースを提供するため</li>
<li><code>Io</code> - <code>socket.io</code>のラッパー</li>
<li><code>config</code> - app.jsで定義されている定数</li>
</ul>
<p><code>Room</code> は以下のpublic APIを提供します。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> api = {</div><div class="line">  joinRoom: <span class="function"><span class="keyword">function</span> <span class="params">(r)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (!connected) {</div><div class="line">      socket.emit(<span class="string">'init'</span>, { room: r }, <span class="function"><span class="keyword">function</span> <span class="params">(roomid, id)</span> </span>{</div><div class="line">        currentId = id;</div><div class="line">        roomId = roomid;</div><div class="line">      });</div><div class="line">      connected = <span class="literal">true</span>;</div><div class="line">    }</div><div class="line">  },</div><div class="line">  createRoom: <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">    <span class="keyword">var</span> d = $q.defer();</div><div class="line">    socket.emit(<span class="string">'init'</span>, <span class="literal">null</span>, <span class="function"><span class="keyword">function</span> <span class="params">(roomid, id)</span> </span>{</div><div class="line">      d.resolve(roomid);</div><div class="line">      roomId = roomid;</div><div class="line">      currentId = id;</div><div class="line">      connected = <span class="literal">true</span>;</div><div class="line">    });</div><div class="line">    <span class="keyword">return</span> d.promise;</div><div class="line">  },</div><div class="line">  init: <span class="function"><span class="keyword">function</span> <span class="params">(s)</span> </span>{</div><div class="line">    stream = s;</div><div class="line">  }</div><div class="line">};</div></pre></td></tr></table></figure>

<p>上で書いたように<code>joinRoom</code>は既存のルームに参加する為に使われます、<code>createRoom</code>は<code>Room</code>サービスを初期化する為に使われ<br>新しいチャットルームの作成の為に使われます。</p>
<p>このサービスで使う<code>socket.io</code>イベントは次の通りです。</p>
<ul>
<li><code>peer.connected</code> - 新しいピアが部屋に参加したときに発火します。このイベントが発火したら、我々はこのピアに対して新しいSDP要求を開始します。</li>
<li><code>peer.disconnected</code> - ピアが切断されたときに発火</li>
<li><code>msg</code> - 新しいSDP申請/回答、またはICE候補を受信したときに発火</li>
</ul>
<p>ピアが部屋に接続したとき、どのように新しい申請をするのかを見てみましょう。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeOffer</span><span class="params">(id)</span> </span>{</div><div class="line">  <span class="keyword">var</span> pc = getPeerConnection(id);</div><div class="line">  pc.createOffer(<span class="function"><span class="keyword">function</span> <span class="params">(sdp)</span> </span>{</div><div class="line">    pc.setLocalDescription(sdp);</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Creating an offer for'</span>, id);</div><div class="line">    socket.emit(<span class="string">'msg'</span>, { by: currentId, to: id, sdp: sdp, type: <span class="string">'sdp-offer'</span> });</div><div class="line">  }, <span class="function"><span class="keyword">function</span> <span class="params">(e)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(e);</div><div class="line">  },</div><div class="line">  { mandatory: { OfferToReceiveVideo: <span class="literal">true</span>, OfferToReceiveAudio: <span class="literal">true</span> }});</div><div class="line">}</div></pre></td></tr></table></figure>

<p>新しいピアが部屋にやってくると、 <code>makeOffer</code> はピアのIDで呼び出されます。<br>まず最初にそのピアIDで<code>getPeerConnection</code>が実行されます。<br>指定されたピアID接続が存在しない場合、 <code>getPeerConnection</code>は新しい<code>RTCPeerConnection</code>を作成して必要なイベントハンドラを追加してから返します。</p>
<p>ピア接続を取得したら、 <code>createOffer</code> メソッドを呼びます。<br>このメソッドは<code>RTCPeerConnection</code>にある内容でSTUNサーバーへの新しい要求を行いつつ、ICE候補の収集を行います。<br>ICE候補やサポートされているコーデックなど、サーバに送信する為のSDP申請を作り上げます。</p>
<p>上にあるサーバーの実装で見たように、イベントオブジェクトの<code>to</code>プロパティが示すピアに申請をリダイレクトします。</p>
<p>次に<code>msg</code>イベントハンドラを見てみましょう。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">socket.on(<span class="string">'msg'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(data)</span> </span>{</div><div class="line">  handleMessage(data);</div><div class="line">});</div></pre></td></tr></table></figure>

<p>ここでは <code>handleMessage</code>を直接呼びます。次のように実装をトレースする事が出来ます。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleMessage</span><span class="params">(data)</span> </span>{</div><div class="line">  <span class="keyword">var</span> pc = getPeerConnection(data.by);</div><div class="line">  <span class="keyword">switch</span> (data.type) {</div><div class="line">    <span class="keyword">case</span> <span class="string">'sdp-offer'</span>:</div><div class="line">      pc.setRemoteDescription(<span class="keyword">new</span> RTCSessionDescription(data.sdp), <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Setting remote description by offer'</span>);</div><div class="line">        pc.createAnswer(<span class="function"><span class="keyword">function</span> <span class="params">(sdp)</span> </span>{</div><div class="line">          pc.setLocalDescription(sdp);</div><div class="line">          socket.emit(<span class="string">'msg'</span>, { by: currentId, to: data.by, sdp: sdp, type: <span class="string">'sdp-answer'</span> });</div><div class="line">        });</div><div class="line">      });</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> <span class="string">'sdp-answer'</span>:</div><div class="line">      pc.setRemoteDescription(<span class="keyword">new</span> RTCSessionDescription(data.sdp), <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Setting remote description by answer'</span>);</div><div class="line">      }, <span class="function"><span class="keyword">function</span> <span class="params">(e)</span> </span>{</div><div class="line">        <span class="built_in">console</span>.error(e);</div><div class="line">      });</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> <span class="string">'ice'</span>:</div><div class="line">      <span class="keyword">if</span> (data.ice) {</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Adding ice candidates'</span>);</div><div class="line">        pc.addIceCandidate(<span class="keyword">new</span> RTCIceCandidate(data.ice));</div><div class="line">      }</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>最初の行で、<code>by</code>プロパティがさすピアIDとのピア接続を取得します。<br>そして接続を取得後、異なるメッセージタイプに切り替えます。</p>
<ul>
<li><p><code>SDP-offer</code> - このメッセージが表示された場合、この部屋の内部ピアのに参加している他の人々が、新しいピア接続を開始したいと申請してきている事を意味します。<br>ICE候補、ビデオコーデック、その他に答えるために <code>createAnswer</code>を使用して新しい回答を作成して、<code>setRemoteDescription</code>を行います。<br>SDPの回答を準備し、サーバーを経由して適切なピアを元に送信します。</p>
</li>
<li><p><code>SDP-answer</code> - 与えられたピアによってSDPの回答を受信して、元のピアにSDNの回答の返しを送ったことを意味しています。<br>リモートの状況を設定し、あとはP2P間でメディア接続を開始するだろうこと（対称的NATの後方ではない事）を願っています。</p>
</li>
<li><p><code>ice</code> - ネゴシエート中に新しいICE候補があれば、<code>RTCPeerConnection</code>インスタンスが現在ネゴシエートしている誰とのピアに新しい<code>msg</code>メッセージをリダイレクトし、<code>onicecandidate</code>イベントをトリガします。<br>その後<code>addIceCandidate</code>メソッドを使用して適切なピア接続にICE候補を追加していきます。</p>
</li>
</ul>
<p>では、このチュートリアルの最後のメソッド<code>getPeerConnection</code>を見て行きましょう。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> peerConnections = {};</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPeerConnection</span><span class="params">(id)</span> </span>{</div><div class="line">  <span class="keyword">if</span> (peerConnections[id]) {</div><div class="line">    <span class="keyword">return</span> peerConnections[id];</div><div class="line">  }</div><div class="line">  <span class="keyword">var</span> pc = <span class="keyword">new</span> RTCPeerConnection(iceConfig);</div><div class="line">  peerConnections[id] = pc;</div><div class="line">  pc.addStream(stream);</div><div class="line">  pc.onicecandidate = <span class="function"><span class="keyword">function</span> <span class="params">(evnt)</span> </span>{</div><div class="line">    socket.emit(<span class="string">'msg'</span>, { by: currentId, to: id, ice: evnt.candidate, type: <span class="string">'ice'</span> });</div><div class="line">  };</div><div class="line">  pc.onaddstream = <span class="function"><span class="keyword">function</span> <span class="params">(evnt)</span> </span>{</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Received new stream'</span>);</div><div class="line">    api.trigger(<span class="string">'peer.stream'</span>, [{</div><div class="line">      id: id,</div><div class="line">      stream: evnt.stream</div><div class="line">    }]);</div><div class="line">    <span class="keyword">if</span> (!$rootScope.$$digest) {</div><div class="line">      $rootScope.$apply();</div><div class="line">    }</div><div class="line">  };</div><div class="line">  <span class="keyword">return</span> pc;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>このメソッドはピアIDと<code>RTCPeerConnection</code> オブジェクトのマッピングを作成する<code>peerConnections</code>オブジェクトを持ちます。<br>最初に与えられたピアID接続に関連する物があるかを確認し、あれば返します。<br>ピア接続が無い場合、イベントハンドラを追加した<code>onicecandidate</code>と<code>onaddstream</code>をキャッシュして返します。</p>
<p><code>onaddstream</code>がトリガされると、接続が正常に開始された事を意味します。<br>以降 <code>peer.stream</code> イベントをトリガしてページ上のvideo要素でその内容を見えるようにすることができます。</p>
<h4 id="ビデオプレイヤー">ビデオプレイヤー</h4>
<p>これがこのアプリケーション最後のコンポーネントです。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yo angular:directive videoPlayer</div></pre></td></tr></table></figure>

<p>ファイル<code>public/app/scripts/directives/videoplayer.js</code>に以下の内容を設定してください。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">angular.module(<span class="string">'publicApp'</span>)</div><div class="line">  .directive(<span class="string">'videoPlayer'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($sce)</span> </span>{</div><div class="line">    <span class="keyword">return</span> {</div><div class="line">      template: <span class="string">'&lt;div&gt;&lt;video ng-src="" autoplay&gt;&lt;/video&gt;&lt;/div&gt;'</span>,</div><div class="line">      restrict: <span class="string">'E'</span>,</div><div class="line">      replace: <span class="literal">true</span>,</div><div class="line">      scope: {</div><div class="line">        vidSrc: <span class="string">'@'</span></div><div class="line">      },</div><div class="line">      link: <span class="function"><span class="keyword">function</span> <span class="params">(scope)</span> </span>{</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Initializing video-player'</span>);</div><div class="line">        scope.trustSrc = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>{</div><div class="line">          <span class="keyword">if</span> (!scope.vidSrc) {</div><div class="line">            <span class="keyword">return</span> <span class="literal">undefined</span>;</div><div class="line">          }</div><div class="line">          <span class="keyword">return</span> $sce.trustAsResourceUrl(scope.vidSrc);</div><div class="line">        };</div><div class="line">      }</div><div class="line">    };</div><div class="line">  });</div></pre></td></tr></table></figure>

<h2 id="終わりに">終わりに</h2>
<p>ではこれから、今まで作ってきた機能の振り返りを行いましょう。</p>
<h3 id="Full-mesh_limitations">Full-mesh limitations</h3>
<p>チュートリアルのデモから体験できるよう、このアプリケーションは１０未満のユーザーなら効率的に動きます。(ただしネットワーク帯域幅やCPUにもよっては５名)</p>
<p>これはfull-meshトポロジの制限です。<br>N対1のセッションを持っているとき、確立すべき<code>RTCPeerConnection</code>が<code>N-1</code>必要になります。<br>この中ではビデオストリームが<code>N-1</code>回エンコードされ、ネットワークを介して<code>N-1</code>回送信される事を意味します。</p>
<p>この処理は非常に非効率的であり、複数の当事者間の通信が必要とされるプロダクトだと非実用的です。<br>この問題の解決策は、WebRTCゲートウェイを使う事です。<br>そしてこの問題を解決する為のいくつかのオープンソースプロジェクトもあります。</p>
<ul>
<li><a href="https://jitsi.org/Projects/JitsiVideobridge" target="_blank" rel="external">Jitsi Videobridge</a> - Jitsi’sチームはシグナリングや接続の確立の為のColibri (Jitsi’sチームによるXMPP拡張)のためのXMPPシグナリングを使っており、WebRTC対応のビデオブリッジの環境を持っています。<br>ブリッジは低い計算能力を持つ安価なハードウェアを使った場合でも効果を十分発揮して、高い品質と転送用のビデオ/オーディオミキシングを提供します。</li>
</ul>
<ul>
<li><a href="http://lynckia.com/licode/" target="_blank" rel="external">licode</a> - シグナリングの為にビデオとオーディオのミキシングとカスタムJSONベースのプロトコルを提供するオープンソースプロジェクトです。私は最後にこれを使ってみましたが、このミキシングはオーディオ接続に使用する事はほぼ不可能なレベルの音質で、高い品質ではありませんでした。</li>
</ul>
<h3 id="シグナリングプロトコル">シグナリングプロトコル</h3>
<p>このチュートリアルではシグナリングの為にカスタムJSONプロトコルを使用していました。<br>より良い選択はXMPPシグナルかSIPなどの標準化プロトコルを使う事でしょう。<br>この選択はあなたが他の既存サービスとサービスを統合する場合に、よりよい柔軟性を発揮します。</p>
<h3 id="その他">その他</h3>
<p>今回私たちがカバーしていない多くのトピックがありますが、残念な事にそれはこのチュートリアルの範囲外です。</p>
<p>さらに興味があるのであれば、以下のリソースを参考にしてください。<br>または、追加情報をpingしてください。</p>
<h2 id="Resources">Resources</h2>
<ul>
<li><a href="http://www.html5rocks.com/en/tutorials/webrtc/basics/" target="_blank" rel="external">HTML5 Rocks WebRTC intro</a></li>
<li><a href="http://www.html5rocks.com/en/tutorials/webrtc/infrastructure/" target="_blank" rel="external">HTML5 Rocks, WebRTC infrastructure</a></li>
<li><a href="http://www.html5rocks.com/en/tutorials/webrtc/datachannels/" target="_blank" rel="external">HTML5 Rocks, WebRTC data channel</a></li>
<li><a href="http://www.webrtc.org/" target="_blank" rel="external">WebRTC.org</a></li>
<li><a href="https://webrtchacks.com/" target="_blank" rel="external">WebRTC hacks</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://msakamaki.github.io/2015/01/08/angularwebrtc/" data-id="ahrtxjjhxjg8c8s3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-mermaid" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/myfreebook/2015/01/06/mermaid/" class="article-date">
  <time datetime="2015-01-06T05:17:59.000Z" itemprop="datePublished">Jan 6 2015</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/myfreebook/2015/01/06/mermaid/">hexoにmeamaidを組み込んでみるテスト</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近<a href="https://github.com/knsv/mermaid" target="_blank" rel="external">meamaid</a>での図形作成にはまってる。</p>
<p>で、hexoオリジナルテーマにmeamaidを組み込んだけれど、単純に組み込んだだけだと動作しなかったのでメモ。</p>
<h4 id="動かなかった原因">動かなかった原因</h4>
<ul>
<li><code>&lt;br&gt;</code>タグとか混ざる</li>
<li><code>--</code>が<code>-</code>に変換される。</li>
</ul>
<h4 id="javascriptから突っ込んでみるとできる。">javascriptから突っ込んでみるとできる。</h4>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="title">div</span> <span class="attribute">id</span>=<span class="value">"drowmmd"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="javascript"></span></div><div class="line">  (<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</div><div class="line">    <span class="built_in">document</span>.getElementById(<span class="string">'drowmmd'</span>).innerHTML </div><div class="line">    = <span class="string">'&lt;div class="mermaid"&gt; graph TD; A--&gt;B; A--&gt;C; B--&gt;D; C--&gt;D; &lt;/div&gt;'</span></div><div class="line">  })();</div><div class="line"><span class="tag">&lt;/<span class="title">script</span>&gt;</span></div></pre></td></tr></table></figure>

<p>で、以下のようにちゃんと変換されて表示される。</p>
<p><div id="drowmmd"></div></p>
<script>
  (function(){
    document.getElementById('drowmmd').innerHTML = '<div class="mermaid"> graph TD; A-->B; A-->C; B-->D; C-->D; </div>'
  })();
</script>

<p>けれども個人的には、mermaid構文のようにもう少し簡単に書きたい。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="keyword">div</span> <span class="type">class</span>=<span class="string">"mermaid"</span>&gt;</div><div class="line"> graph TD;</div><div class="line">   A<span class="comment">--&gt;B;</span></div><div class="line">   A<span class="comment">--&gt;C;</span></div><div class="line">   B<span class="comment">--&gt;D;</span></div><div class="line">   C<span class="comment">--&gt;D;</span></div><div class="line">&lt;/<span class="keyword">div</span>&gt;</div></pre></td></tr></table></figure>

<p>ので、カスタムmarkdown機能を組み込んでみる。</p>
<p><a href="https://github.com/akfish/hexo-renderer-marked-plus" target="_blank" rel="external">hexo-renderer-marked-plus</a> でMarkdownの内容をオーバライドできるようなので、ひとまずHexoにinstallする。</p>
<ul>
<li>hexoフォルダに以下を実行</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm install hexo-renderer-marked-plus --save</div></pre></td></tr></table></figure>

<p>で、<code>themes/自分のテーマ/scripts/markedrenderer.js</code>に以下のコードを追加して、独自解釈をできるように。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> marmaid ={</div><div class="line">  inline: <span class="regexp">/^mermaid\n/</span></div><div class="line">};</div><div class="line"></div><div class="line">hexo.markedRenderer = {</div><div class="line">  codespan: <span class="function"><span class="keyword">function</span><span class="params">(code)</span> </span>{</div><div class="line">    <span class="keyword">if</span> (marmaid.inline.test(code)) {</div><div class="line">      <span class="keyword">return</span> <span class="string">'&lt;div class="mermaid"&gt;'</span> + code.replace(marmaid.inline,<span class="string">''</span>) + <span class="string">'&lt;/div&gt;'</span></div><div class="line">    }</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._super.codespan(code);</div><div class="line">  }</div><div class="line">}</div></pre></td></tr></table></figure>

<p>これで以下のように書くと。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">`mermaid</span></div><div class="line"> <span class="comment">graph</span> <span class="comment">TD;</span></div><div class="line">   <span class="comment">A</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">B;</span></div><div class="line">   <span class="comment">A</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">C;</span></div><div class="line">   <span class="comment">B</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">D;</span></div><div class="line">   <span class="comment">C</span><span class="literal">-</span><span class="literal">-</span>&gt;<span class="comment">D;</span></div><div class="line"><span class="comment">`</span></div></pre></td></tr></table></figure>

<p>下のようにhexo上でmermaidが書けるようになる。</p>
<p><div class="mermaid"> graph TD;
   A--&gt;B;
   A--&gt;C;
   B--&gt;D;
   C--&gt;D;</div></p>
<p>mermaid自体、最近シーケンス図書けるようになったりしてるので、今のうちにくみこんでみたけれど<br>merkdownライクにフローチャートやシーケンスが書けるのは凄い良い気がする。</p>
<p><div class="mermaid">sequenceDiagram
    Hexo-&gt;&gt;Mermaid: Covert?
    Hexo--&gt;Mermaid: Drow!</div></p>
<p>次回調べたいもの</p>
<ul>
<li><a href="https://github.com/mgechev/angular-webrtc" target="_blank" rel="external">Angular WebRTC</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://msakamaki.github.io/2015/01/06/mermaid/" data-id="o17vn6dm24ournfs" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
  
</section>
        
          <aside id="sidebar">
  
    
  
    
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/myfreebook/archives/2015/01/">January 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/myfreebook/archives/2014/12/">December 2014</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/myfreebook/2015/01/08/angularwebrtc/">Multi-User Video Conference with WebRTCの意訳</a>
          </li>
        
          <li>
            <a href="/myfreebook/2015/01/06/mermaid/">hexoにmeamaidを組み込んでみるテスト</a>
          </li>
        
          <li>
            <a href="/myfreebook/2014/12/25/20141225/">最近気になったOSS UIまとめ</a>
          </li>
        
          <li>
            <a href="/myfreebook/2014/12/08/use-hexo/">hexoを使ってみる</a>
          </li>
        
          <li>
            <a href="/myfreebook/2014/12/05/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 MSakamaki<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/myfreebook/" class="mobile-nav-link">Home</a>
  
    <a href="/myfreebook/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/myfreebook/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/myfreebook/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>



<script src="/myfreebook/mermaid/mermaid.full.min.js" type="text/javascript"></script>


<script src="/myfreebook/js/script.js" type="text/javascript"></script>


  </div>
</body>
</html>